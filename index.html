<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Precios El Barquillo</title>
  <link rel="stylesheet" href="styles.css">
  <!-- SheetJS para Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- jsPDF para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- docx.js para Word -->
<script src="https://cdn.jsdelivr.net/npm/docx@8.4.0/build/index.min.js"></script>
<!-- Chart.js para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Modal animaci√≥n y layout */
    .modal-mesa {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
    }
    .modal-mesa.show {
      opacity: 1;
      pointer-events: auto;
    }
    .modal-content {
      background: #fff;
      border-radius: 14px;
      padding: 24px;
      max-width: 350px;
      margin: auto;
      text-align: center;
      box-shadow: 0 2px 16px #aaa;
      box-sizing: border-box;
      width: 100%;
      overflow-x: auto;
    }
    .mesa-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 10px;
      margin: 18px 0;
      max-width: 100%;
    }
    .mesa-btn {
      background: #0564f1;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .mesa-btn.selected {
      background: #ff4081;
    }
    .cerrar-btn {
      background: #ff4081;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    @media (max-width: 600px) {
      .modal-content {
        max-width: 95vw;
        padding: 10px;
      }
      .mesa-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
    }
    header {
      background:#0564f1;
      color:white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding:12px 18px;
      font-size:18px;
      font-weight:bold;
    }
    #user-info {
      margin-left: auto;
      margin-right: 0;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
    }
    #user-name {
      font-weight: bold;
      font-size: 17px;
      letter-spacing: 1px;
    }
    #btn-logout {
      background:#ff4081;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:5px 12px;
      font-weight:bold;
      cursor:pointer;
    }

   /* ...estilos existentes... */
    @media (max-width: 900px) {
      #admin-panel {
        max-width: 98vw;
        padding: 8px;
      }
      #ventas-chart, #productos-chart {
        max-width: 100vw !important;
      }
      table {
        font-size: 13px !important;
      }
    }
#login-container {
  background: rgba(255,255,255,0.92);
  position: relative;
  z-index: 2;
}

body.login-bg {
  background: url('img/app.jpg') no-repeat center center fixed;
  background-size: cover;
}

#login-container h2 {
  font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
  font-size: 2.2rem;
  font-weight: 900;
  color: #0564f1;
  letter-spacing: 2px;
  margin-bottom: 18px;
  text-shadow: 1px 2px 8px #b3d1ff;
}

#login-container label {
  font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
  font-size: 1.1rem;
  font-weight: 600;
  color: #333;
  margin-bottom: 2px;
  display: block;
}

#login-container input[type="text"],
#login-container input[type="password"] {
  font-size: 1.1rem;
  border: 2px solid #0564f1;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 14px;
  background: #f7faff;
  transition: border 0.2s;
}

#login-container input:focus {
  border-color: #ff4081;
  outline: none;
}

#login-container button[type="submit"] {
  background: linear-gradient(90deg, #0564f1 60%, #ff4081 100%);
  color: #fdfdfd;
  font-size: 1.2rem;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  padding: 12px 0;
  margin-top: 10px;
  box-shadow: 0 2px 8px #b3d1ff;
  cursor: pointer;
  transition: background 0.2s;
}

#login-container button[type="submit"]:hover {
  background: linear-gradient(90deg, #ff4081 60%, #0564f1 100%);
}

#login-error {
  font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
  font-size: 1rem;
  font-weight: bold;
  color: #ff4081;
  margin-top: 10px;
  text-shadow: 1px 1px 4px #fff;
}

.login-logo {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 24px;
  margin-bottom: 8px;
}

.login-logo img {
  max-width: 180px;
  width: 60vw;
  height: auto;
  border-radius: 18px;
  box-shadow: 0 2px 12px #0563f100;
  background: transparent; /* Fondo transparente */
  padding: 8px;
}

@media (max-width: 600px) {
  .login-logo img {
    max-width: 120px;
    width: 80vw;
    padding: 4px;
  }
}


  </style>
</head>
<body>

<header>
  <span style="font-size:22px;font-weight:bold;">Precios El Barquillo</span>
  <span id="user-info" style="margin-left:auto;display:none;">
    <span id="user-name"></span>
    <button id="btn-logout">Salir</button>
  </span>
  <span id="admin-panel-btn" style="display:none;">
    <button id="btn-admin-panel" style="background:#fff;color:#0564f1;border:none;border-radius:6px;padding:5px 12px;font-weight:bold;cursor:pointer;">Panel Admin</button>
  </span>
</header>

<div class="tabs"></div>

<!-- Login -->
<div id="login-container" style="max-width:350px;margin:40px auto;padding:30px;background:#fff;border-radius:10px;box-shadow:0 2px 8px #eee;display:none;">
  <h2 style="text-align:center;">Iniciar sesi√≥n</h2>
  <form id="login-form">
    <label>Usuario</label>
    <input type="text" id="username" required style="width:100%;margin-bottom:10px;">
    <label>Contrase√±a</label>
    <input type="password" id="password" required style="width:100%;margin-bottom:10px;">
    <button type="submit" style="width:100%;background:#0564f1;color:#fff;padding:10px;border:none;border-radius:6px;font-weight:bold;">Entrar</button>
    <div id="login-error" style="color:red;text-align:center;margin-top:10px;display:none;"></div>
  </form>
  <div class="login-logo">
    <img src="img/logo.png" alt="Logo El Barquillo">
  </div>
</div>
<!-- ...resto del c√≥digo... -->



<!-- Men√∫ principal para administradores -->
<div id="main-menu" style="display:none;max-width:400px;margin:40px auto;padding:30px;background:#fff;border-radius:10px;box-shadow:0 2px 8px #eee;">
  <h2 style="text-align:center;">Men√∫ principal</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px;">
    <button id="menu-admin-panel" style="background:#0564f1;color:#fff;border:none;border-radius:10px;padding:30px 10px;font-size:20px;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;align-items:center;">
      <span style="font-size:40px;">üõ†Ô∏è</span>
      <span>Panel Admin</span>
    </button>
    <button id="menu-realizar-pedido" style="background:#ff4081;color:#fff;border:none;border-radius:10px;padding:30px 10px;font-size:20px;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;align-items:center;">
      <span style="font-size:40px;">üõí</span>
      <span>Realizar Pedido</span>
    </button>
    <button id="menu-modificar-mesas-deliverys" style="background:#00b894;color:#fff;border:none;border-radius:10px;padding:30px 10px;font-size:20px;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;align-items:center;">
      <span style="font-size:40px;">üìù</span>
      <span>Modificar mesas y deliverys</span>
    </button>
  </div>
</div>

<div id="especiales" class="section productos-grid"></div>
<div id="cafe" class="section productos-grid"></div>
<div id="postres" class="section productos-grid"></div>
<div id="helados" class="section productos-grid"></div>
<div id="licuados" class="section productos-grid"></div>
<div id="sorbete" class="section productos-grid"></div>
<div id="sundaes" class="section productos-grid"></div>
<div id="litros" class="section productos-grid"></div>
<div id="varios" class="section productos-grid"></div>

<div class="footer">
  <div class="pedido-tipo">
    <button id="btn-mesa" type="button" class="tipo-btn"><span>üçΩÔ∏è</span> Mesa</button>
    <button id="btn-delivery" type="button" class="tipo-btn"><span>üöö</span> Delivery</button>
  </div>
  <!-- Modal Mesa -->
  <div id="mesa-modal" class="modal-mesa">
    <div class="modal-content">
      <h3>Selecciona la mesa</h3>
      <div class="mesa-grid"></div>
      <button id="cerrar-mesa" class="cerrar-btn">Cerrar</button>
    </div>
  </div>
  <!-- Modal Delivery -->
  <div id="delivery-modal" class="modal-mesa">
    <div class="modal-content">
      <h3>Selecciona el delivery</h3>
      <select id="delivery-select" style="width:100%;font-size:18px;padding:8px;border-radius:8px;">
        <option value="">Selecciona delivery</option>
        <option value="Flash Delivery">Flash Delivery</option>
        <option value="Delivery 1">Delivery 1</option>
        <option value="Delivery 2">Delivery 2</option>
      </select>
      <button id="cerrar-delivery" class="cerrar-btn">Cerrar</button>
    </div>
  </div>
  <div class="footer-actions">
    <span class="total-label">Total: $<span id="total">0.00</span></span>
    <button id="btn-borrar" class="footer-btn">üóëÔ∏è Borrar</button>
    <button id="btn-realizar" class="footer-btn">‚úÖ Realizar pedido</button>
  </div>
</div>

<!-- Modal Advertencia -->
<div id="modal-advertencia" class="modal-mesa">
  <div class="modal-content">
    <h3>Por favor selecciona d√≥nde servir√°s tu pedido</h3>
    <p>Debes elegir <b>Mesa</b> o <b>Delivery</b> antes de continuar.</p>
    <button id="cerrar-advertencia" class="cerrar-btn">Cerrar</button>
  </div>
</div>

<!-- Modal revisi√≥n de pedido antes de confirmar -->
<div id="modal-revision-pedido" class="modal-mesa">
  <div class="modal-content" style="max-width:400px;">
    <h3>Revisi√≥n del pedido</h3>
    <div id="pedido-detalle"></div>
    <button id="confirmar-pedido" class="footer-btn" style="margin-top:12px;">Confirmar pedido</button>
    <button id="cerrar-revision-pedido" class="cerrar-btn" style="margin-top:8px;">Cancelar</button>
  </div>
</div>

<!-- Modal confirmaci√≥n de pedido -->
<div id="modal-confirmacion-pedido" class="modal-mesa">
  <div class="modal-content">
    <h3>¬°Has agregado un nuevo pedido con exito!</h3>
    <button id="cerrar-confirmacion-pedido" class="cerrar-btn" style="margin-top:12px;">Aceptar</button>
  </div>
</div>

<!-- Panel admin (no modal) -->
<div id="admin-panel" style="display:none;max-width:1000px;margin:30px auto;padding:24px;background:#fff;border-radius:14px;box-shadow:0 2px 16px #aaa;">
  <div style="display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:10px;">
    <h2 style="margin:0;">Ventas y pedidos</h2>
    <button id="cerrar-admin-panel" style="background:#ff4081;color:#fff;border:none;border-radius:6px;padding:5px 12px;font-weight:bold;cursor:pointer;">Cerrar</button>
  </div>
  <div style="margin:18px 0;display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
    <label>Rango de fechas:</label>
    <input type="date" id="admin-fecha-inicio">
    <input type="date" id="admin-fecha-fin">
    <span id="total-ventas" style="font-weight:bold;margin-left:20px;">Total ventas: $0.00</span>
    <button id="export-excel" style="margin-left:20px;">Exportar Excel</button>
    <button id="export-word">Exportar Word</button>
    <button id="export-pdf">Exportar PDF</button>
    <button id="export-whatsapp">WhatsApp</button>
  </div>
  <div style="margin-bottom:20px;">
    <canvas id="ventas-chart" style="max-width:100%;"></canvas>
  </div>
  <div id="admin-pedidos-list"></div>
  <h3 style="margin-top:40px;">Productos m√°s y menos vendidos</h3>
  <div style="margin-bottom:20px;">
    <canvas id="productos-chart" style="max-width:100%;"></canvas>
  </div>
  <div id="productos-mas-menos"></div>
</div>

<!-- Panel modificar mesas y deliverys -->
<div id="panel-mesas-deliverys" style="display:none;max-width:500px;margin:30px auto;padding:24px;background:#fff;border-radius:14px;box-shadow:0 2px 16px #aaa;">
  <h2 style="text-align:center;">Modificar mesas y deliverys</h2>
  <div style="margin-bottom:24px;">
    <h3>Mesas</h3>
    <ul id="lista-mesas"></ul>
    <input type="number" id="nueva-mesa-num" min="1" placeholder="N√∫mero de mesa" style="width:120px;">
    <button id="agregar-mesa" style="background:#0564f1;color:#fff;border:none;border-radius:6px;padding:5px 12px;font-weight:bold;cursor:pointer;">Agregar mesa</button>
  </div>
  <div>
    <h3>Deliverys</h3>
    <ul id="lista-deliverys"></ul>
    <input type="text" id="nuevo-delivery-nombre" placeholder="Nombre delivery" style="width:180px;">
    <button id="agregar-delivery" style="background:#0564f1;color:#fff;border:none;border-radius:6px;padding:5px 12px;font-weight:bold;cursor:pointer;">Agregar delivery</button>
  </div>
  <button id="cerrar-panel-mesas-deliverys" class="cerrar-btn" style="margin-top:24px;">Cerrar</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const users = [
  { username: "admin", password: "admin12345", role: "administrador" },
  { username: "toto", password: "admin123", role: "administrador" },
  { username: "vendedor", password: "venta123", role: "vendedor" }
];

let pedidoTipo = "";
let mesaSeleccionada = "";

// --- Mesas y Deliverys din√°micos ---
function getMesas() {
  return JSON.parse(localStorage.getItem("mesas") || "[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]");
}
function setMesas(mesas) {
  localStorage.setItem("mesas", JSON.stringify(mesas));
}
function getDeliverys() {
  return JSON.parse(localStorage.getItem("deliverys") || '["Flash Delivery","Delivery 1","Delivery 2"]');
}
function setDeliverys(deliverys) {
  localStorage.setItem("deliverys", JSON.stringify(deliverys));
}
function renderMesaModal() {
  const grid = document.querySelector(".mesa-grid");
  grid.innerHTML = "";
  getMesas().forEach(num => {
    const btn = document.createElement("button");
    btn.className = "mesa-btn";
    btn.textContent = "Mesa " + num;
    btn.onclick = function() {
      document.querySelectorAll(".mesa-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      mesaSeleccionada = num;
    };
    grid.appendChild(btn);
  });
}
function renderDeliverySelect() {
  const select = document.getElementById("delivery-select");
  select.innerHTML = `<option value="">Selecciona delivery</option>` +
    getDeliverys().map(nombre => `<option value="${nombre}">${nombre}</option>`).join("");
}

// --- Usuario y logout ---
function mostrarUsuario() {
  const user = localStorage.getItem("userName");
  if (user) {
    document.getElementById("user-name").textContent = user;
    document.getElementById("user-info").style.display = "flex";
  } else {
    document.getElementById("user-info").style.display = "none";
  }
}
document.getElementById("btn-logout").onclick = function() {
  localStorage.removeItem("userRole");
  localStorage.removeItem("userName");
  location.reload();
};

// --- Login ---
document.getElementById("login-form").onsubmit = function(e) {
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const user = users.find(u => u.username === username && u.password === password);
  const errorDiv = document.getElementById("login-error");
  if (user) {
    localStorage.setItem("userRole", user.role);
    localStorage.setItem("userName", user.username);
    location.reload();
  } else {
    errorDiv.textContent = "Usuario o contrase√±a incorrectos";
    errorDiv.style.display = "block";
  }
};

// --- Navegaci√≥n y visibilidad ---
function mostrarPantalla() {
  const isLogged = !!localStorage.getItem("userRole");
  const role = localStorage.getItem("userRole");
  mostrarUsuario();

  document.getElementById("login-container").style.display = isLogged ? "none" : "";
  document.body.querySelector("header").style.display = isLogged ? "" : "none";
  document.getElementById("main-menu").style.display = "none";
  document.body.querySelector(".tabs").style.display = "none";
  document.body.querySelector(".footer").style.display = "none";
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  document.getElementById("admin-panel").style.display = "none";
  document.getElementById("panel-mesas-deliverys").style.display = "none";

  if (isLogged && role === "administrador") {
    document.getElementById("main-menu").style.display = "";
    document.getElementById("admin-panel-btn").style.display = "flex";
  } else if (isLogged && role === "vendedor") {
    // Mostrar productos y footer para vendedor
    document.body.querySelector(".tabs").style.display = "";
    document.body.querySelector(".footer").style.display = "";
    document.querySelectorAll(".section").forEach(s => s.style.display = "");
    document.getElementById("admin-panel-btn").style.display = "none";
  }
}

window.addEventListener("DOMContentLoaded", mostrarPantalla);

window.addEventListener("DOMContentLoaded", function() {
  mostrarPantalla();
  // Fondo solo para login
  if (document.getElementById("login-container").style.display !== "none") {
    document.body.classList.add("login-bg");
  } else {
    document.body.classList.remove("login-bg");
  }
});

// --- Men√∫ principal ---
document.getElementById("menu-admin-panel").onclick = function() {
  document.getElementById("main-menu").style.display = "none";
  document.getElementById("admin-panel").style.display = "block";
  document.getElementById("panel-mesas-deliverys").style.display = "none";
  document.body.querySelector(".tabs").style.display = "none";
  document.body.querySelector(".footer").style.display = "none";
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  inicializarPanelAdmin();
};
document.getElementById("btn-admin-panel").onclick = function() {
  document.getElementById("main-menu").style.display = "none";
  document.getElementById("admin-panel").style.display = "block";
  document.getElementById("panel-mesas-deliverys").style.display = "none";
  document.body.querySelector(".tabs").style.display = "none";
  document.body.querySelector(".footer").style.display = "none";
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  inicializarPanelAdmin();
};
document.getElementById("menu-realizar-pedido").onclick = function() {
  document.getElementById("main-menu").style.display = "none";
  document.getElementById("admin-panel").style.display = "none";
  document.getElementById("panel-mesas-deliverys").style.display = "none";
  document.body.querySelector(".tabs").style.display = "";
  document.body.querySelector(".footer").style.display = "";
  document.querySelectorAll(".section").forEach(s => s.style.display = "");
};
document.getElementById("menu-modificar-mesas-deliverys").onclick = function() {
  document.getElementById("main-menu").style.display = "none";
  document.getElementById("admin-panel").style.display = "none";
  document.getElementById("panel-mesas-deliverys").style.display = "block";
  document.body.querySelector(".tabs").style.display = "none";
  document.body.querySelector(".footer").style.display = "none";
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  renderMesasDeliverys();
};
document.getElementById("cerrar-panel-mesas-deliverys").onclick = function() {
  document.getElementById("panel-mesas-deliverys").style.display = "none";
  document.getElementById("main-menu").style.display = "";
};
document.getElementById("cerrar-admin-panel").onclick = function() {
  document.getElementById("admin-panel").style.display = "none";
  document.getElementById("main-menu").style.display = "";
};

// --- Panel Admin: filtros, exportar, gr√°ficos, tabla ---
function getTodayStr() {
  const d = new Date();
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${year}-${month}-${day}`;
}
function inicializarPanelAdmin() {
  const today = getTodayStr();
  document.getElementById("admin-fecha-inicio").value = today;
  document.getElementById("admin-fecha-fin").value = today;
  mostrarPedidosAdmin();
  mostrarGraficoVentas();
  mostrarProductosVendidos();
}
function filtrarPedidosPorRango(pedidos, inicio, fin) {
  return pedidos.filter(p => {
    const [d,m,y] = p.fecha.split("/");
    const fechaPedido = `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    return fechaPedido >= inicio && fechaPedido <= fin;
  });
}
function mostrarPedidosAdmin(sortCol = null, sortDir = 'asc') {
  const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
  const fechaInicio = document.getElementById("admin-fecha-inicio").value;
  const fechaFin = document.getElementById("admin-fecha-fin").value;
  let filtrados = filtrarPedidosPorRango(pedidos, fechaInicio, fechaFin);

  // Ordenar si corresponde
  if (sortCol) {
    filtrados.sort((a, b) => {
      let va = a[sortCol], vb = b[sortCol];
      if (sortCol === 'total') { va = Number(va); vb = Number(vb); }
      if (va < vb) return sortDir === 'asc' ? -1 : 1;
      if (va > vb) return sortDir === 'asc' ? 1 : -1;
      return 0;
    });
  }

  // Total ventas
  const totalVentas = filtrados.reduce((acc, p) => acc + p.total, 0);
  document.getElementById("total-ventas").textContent = `Total ventas: $${totalVentas.toFixed(2)}`;

  // Tabla pedidos
  let html = `<table id="tabla-pedidos" style="width:100%;border-collapse:collapse;font-size:15px;">
    <thead>
      <tr style="background:#eee;cursor:pointer;">
        <th data-col="numeroPedido">#</th>
        <th data-col="fecha">Fecha</th>
        <th data-col="hora">Hora</th>
        <th data-col="tipo">Tipo</th>
        <th data-col="mesa">Mesa</th>
        <th data-col="delivery">Delivery</th>
        <th>Productos</th>
        <th data-col="total">Total</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>`;
  filtrados.forEach((p, idx) => {
    html += `<tr>
      <td>${p.numeroPedido}</td>
      <td>${p.fecha}</td>
      <td>${p.hora}</td>
      <td>${p.tipo}</td>
      <td>${p.mesa ? p.mesa : "-"}</td>
      <td>${p.delivery ? p.delivery : "-"}</td>
      <td>
        <ul style="margin:0;padding-left:18px;">
          ${p.productos.map(prod => `<li>${prod.cantidad} x ${prod.nombre} ($${prod.precio})</li>`).join("")}
        </ul>
      </td>
      <td>$${p.total.toFixed(2)}</td>
      <td>
        <button class="editar-pedido" data-idx="${idx}" style="background:#0564f1;color:#fff;border:none;border-radius:6px;padding:2px 8px;cursor:pointer;">Editar</button>
        <button class="eliminar-pedido" data-idx="${idx}" style="background:#ff4081;color:#fff;border:none;border-radius:6px;padding:2px 8px;cursor:pointer;">Eliminar</button>
      </td>
    </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("admin-pedidos-list").innerHTML = html;

  // Filtros al pulsar t√≠tulos
  document.querySelectorAll("#tabla-pedidos th[data-col]").forEach(th => {
    th.onclick = function() {
      const col = th.dataset.col;
      let dir = th.dataset.dir === 'asc' ? 'desc' : 'asc';
      th.dataset.dir = dir;
      mostrarPedidosAdmin(col, dir);
    };
  });

  // Editar y eliminar
  document.querySelectorAll(".editar-pedido").forEach(btn => {
    btn.onclick = function() {
      const idx = parseInt(btn.dataset.idx);
      alert("Funci√≥n de edici√≥n de pedido. Puedes expandir para mostrar un modal de edici√≥n.");
    };
  });
  document.querySelectorAll(".eliminar-pedido").forEach(btn => {
    btn.onclick = function() {
      const idx = parseInt(btn.dataset.idx);
      eliminarPedido(idx, filtrados);
    };
  });
}
function eliminarPedido(idx, pedidosFiltrados) {
  if (!confirm("¬øSeguro que deseas eliminar este pedido?")) return;
  const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
  const pedidoNum = pedidosFiltrados[idx].numeroPedido;
  const indexReal = pedidos.findIndex(p => p.numeroPedido === pedidoNum);
  if (indexReal !== -1) {
    pedidos.splice(indexReal, 1);
    localStorage.setItem("pedidos", JSON.stringify(pedidos));
    mostrarPedidosAdmin();
    mostrarGraficoVentas();
    mostrarProductosVendidos();
  }
}
function mostrarGraficoVentas() {
  const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
  const fechaInicio = document.getElementById("admin-fecha-inicio").value;
  const fechaFin = document.getElementById("admin-fecha-fin").value;
  const filtrados = filtrarPedidosPorRango(pedidos, fechaInicio, fechaFin);

  const ventasPorFecha = {};
  filtrados.forEach(p => {
    ventasPorFecha[p.fecha] = (ventasPorFecha[p.fecha] || 0) + p.total;
  });
  const fechas = Object.keys(ventasPorFecha);
  const ventas = fechas.map(f => ventasPorFecha[f]);

  const ctx = document.getElementById("ventas-chart").getContext("2d");
  if (window.ventasChart) window.ventasChart.destroy();
  window.ventasChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: fechas,
      datasets: [{
        label: 'Ventas por d√≠a',
        data: ventas,
        backgroundColor: '#0564f1'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
}
function mostrarProductosVendidos(sortCol = null, sortDir = 'desc') {
  const pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
  const fechaInicio = document.getElementById("admin-fecha-inicio").value;
  const fechaFin = document.getElementById("admin-fecha-fin").value;
  const filtrados = filtrarPedidosPorRango(pedidos, fechaInicio, fechaFin);

  const productos = {};
  filtrados.forEach(p => {
    p.productos.forEach(prod => {
      if (!productos[prod.nombre]) productos[prod.nombre] = { nombre: prod.nombre, cantidad: 0, total: 0 };
      productos[prod.nombre].cantidad += prod.cantidad;
      productos[prod.nombre].total += prod.precio * prod.cantidad;
    });
  });
  let lista = Object.values(productos);

  if (sortCol) {
    lista.sort((a, b) => {
      let va = a[sortCol], vb = b[sortCol];
      if (va < vb) return sortDir === 'asc' ? -1 : 1;
      if (va > vb) return sortDir === 'asc' ? 1 : -1;
      return 0;
    });
  } else {
    lista.sort((a, b) => b.cantidad - a.cantidad);
  }

  let html = `<table id="tabla-productos" style="width:100%;border-collapse:collapse;font-size:15px;">
    <thead>
      <tr style="background:#eee;cursor:pointer;">
        <th data-col="nombre">Producto</th>
        <th data-col="cantidad">Cantidad vendida</th>
        <th data-col="total">Total vendido</th>
      </tr>
    </thead>
    <tbody>`;
  lista.forEach(prod => {
    html += `<tr>
      <td>${prod.nombre}</td>
      <td>${prod.cantidad}</td>
      <td>$${prod.total.toFixed(2)}</td>
    </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("productos-mas-menos").innerHTML = html;

  document.querySelectorAll("#tabla-productos th[data-col]").forEach(th => {
    th.onclick = function() {
      const col = th.dataset.col;
      let dir = th.dataset.dir === 'asc' ? 'desc' : 'asc';
      th.dataset.dir = dir;
      mostrarProductosVendidos(col, dir);
    };
  });

  const ctx = document.getElementById("productos-chart").getContext("2d");
  if (window.productosChart) window.productosChart.destroy();
  window.productosChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: lista.map(p => p.nombre),
      datasets: [{
        label: 'Cantidad vendida',
        data: lista.map(p => p.cantidad),
        backgroundColor: '#05e9f1'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
}

// --- Exportar ---
document.getElementById("export-excel").onclick = function() {
  const tabla = document.getElementById("tabla-pedidos");
  const wb = XLSX.utils.table_to_book(tabla, {sheet:"Pedidos"});
  XLSX.writeFile(wb, "ventas_pedidos.xlsx");
};
document.getElementById("export-word").onclick = function() {
  const tabla = document.getElementById("tabla-pedidos");
  let html = tabla.outerHTML;
  const blob = new Blob(['\ufeff', html], {type: 'application/msword'});
  const url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'ventas_pedidos.doc';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};
document.getElementById("export-pdf").onclick = function() {
  const tabla = document.getElementById("tabla-pedidos");
  const doc = new window.jspdf.jsPDF();
  doc.text("Ventas y pedidos", 10, 10);
  let y = 20;
  Array.from(tabla.rows).forEach(row => {
    let txt = Array.from(row.cells).map(cell => cell.innerText).join(" | ");
    doc.text(txt, 10, y);
    y += 8;
  });
  doc.save("ventas_pedidos.pdf");
};
document.getElementById("export-whatsapp").onclick = function() {
  const tabla = document.getElementById("tabla-pedidos");
  let txt = "Ventas y pedidos:\n";
  Array.from(tabla.rows).forEach(row => {
    txt += Array.from(row.cells).map(cell => cell.innerText).join(" | ") + "\n";
  });
  const url = "https://wa.me/?text=" + encodeURIComponent(txt);
  window.open(url, "_blank");
};

// --- Filtros ---
document.getElementById("admin-fecha-inicio").onchange = function() {
  mostrarPedidosAdmin();
  mostrarGraficoVentas();
  mostrarProductosVendidos();
};
document.getElementById("admin-fecha-fin").onchange = function() {
  mostrarPedidosAdmin();
  mostrarGraficoVentas();
  mostrarProductosVendidos();
};

// --- Mesas y Deliverys panel ---
function renderMesasDeliverys() {
  // Mesas
  const mesas = getMesas();
  const ulMesas = document.getElementById("lista-mesas");
  ulMesas.innerHTML = mesas.map((num, idx) =>
    `<li>
      Mesa ${num}
      <button onclick="editarMesa(${idx})" style="background:#0564f1;color:#fff;border:none;border-radius:6px;padding:2px 8px;cursor:pointer;">Editar</button>
      <button onclick="eliminarMesa(${idx})" style="background:#ff4081;color:#fff;border:none;border-radius:6px;padding:2px 8px;cursor:pointer;">Eliminar</button>
    </li>`
  ).join("");
  // Deliverys
  const deliverys = getDeliverys();
  const ulDeliverys = document.getElementById("lista-deliverys");
  ulDeliverys.innerHTML = deliverys.map((nombre, idx) =>
    `<li>
      ${nombre}
      <button onclick="editarDelivery(${idx})" style="background:#0564f1;color:#fff;border:none;border-radius:6px;padding:2px 8px;cursor:pointer;">Editar</button>
      <button onclick="eliminarDelivery(${idx})" style="background:#ff4081;color:#fff;border:none;border-radius:6px;padding:2px 8px;cursor:pointer;">Eliminar</button>
    </li>`
  ).join("");
}
window.editarMesa = function(idx) {
  const mesas = getMesas();
  const nuevo = prompt("Nuevo n√∫mero para la mesa:", mesas[idx]);
  if (nuevo && !isNaN(nuevo)) {
    mesas[idx] = parseInt(nuevo);
    setMesas(mesas);
    renderMesasDeliverys();
  }
};
window.eliminarMesa = function(idx) {
  const mesas = getMesas();
  if (confirm("¬øEliminar esta mesa?")) {
    mesas.splice(idx, 1);
    setMesas(mesas);
    renderMesasDeliverys();
  }
};
document.getElementById("agregar-mesa").onclick = function() {
  const num = parseInt(document.getElementById("nueva-mesa-num").value);
  if (num && !isNaN(num)) {
    const mesas = getMesas();
    mesas.push(num);
    setMesas(mesas);
    document.getElementById("nueva-mesa-num").value = "";
    renderMesasDeliverys();
  }
};
window.editarDelivery = function(idx) {
  const deliverys = getDeliverys();
  const nuevo = prompt("Nuevo nombre para el delivery:", deliverys[idx]);
  if (nuevo && nuevo.trim()) {
    deliverys[idx] = nuevo.trim();
    setDeliverys(deliverys);
    renderMesasDeliverys();
  }
};
window.eliminarDelivery = function(idx) {
  const deliverys = getDeliverys();
  if (confirm("¬øEliminar este delivery?")) {
    deliverys.splice(idx, 1);
    setDeliverys(deliverys);
    renderMesasDeliverys();
  }
};
document.getElementById("agregar-delivery").onclick = function() {
  const nombre = document.getElementById("nuevo-delivery-nombre").value.trim();
  if (nombre) {
    const deliverys = getDeliverys();
    deliverys.push(nombre);
    setDeliverys(deliverys);
    document.getElementById("nuevo-delivery-nombre").value = "";
    renderMesasDeliverys();
  }
};

// --- Modal mesa y delivery ---
document.getElementById("btn-mesa").onclick = function() {
  pedidoTipo = "mesa";
  document.getElementById("btn-mesa").classList.add("selected");
  document.getElementById("btn-delivery").classList.remove("selected");
  renderMesaModal();
  document.getElementById("mesa-modal").classList.add("show");
  document.getElementById("delivery-modal").classList.remove("show");
};
document.getElementById("cerrar-mesa").onclick = function() {
  document.getElementById("mesa-modal").classList.remove("show");
};
document.getElementById("btn-delivery").onclick = function() {
  pedidoTipo = "delivery";
  mesaSeleccionada = "";
  document.getElementById("btn-delivery").classList.add("selected");
  document.getElementById("btn-mesa").classList.remove("selected");
  renderDeliverySelect();
  document.getElementById("delivery-modal").classList.add("show");
  document.getElementById("mesa-modal").classList.remove("show");
};
document.getElementById("cerrar-delivery").onclick = function() {
  document.getElementById("delivery-modal").classList.remove("show");
};

// ...dentro de tu <script> principal, justo antes del bot√≥n "Realizar pedido"...

// --- Bot√≥n Realizar Pedido y Confirmar Pedido ---
document.getElementById("btn-realizar").onclick = function() {
  // Lee el carrito real
  let carrito = [];
  try { carrito = JSON.parse(localStorage.getItem('carrito') || '[]'); } catch(e){ carrito = []; }

  if (!carrito.length) {
    alert("No hay productos seleccionados.");
    return;
  }

  // Renderiza el detalle del pedido en el modal de revisi√≥n
  let detalle = document.getElementById("pedido-detalle");
  let html = "<ul style='text-align:left;'>";
  carrito.forEach(prod => {
    html += `<li>${prod.cantidad} x ${prod.nombre} ($${prod.precio})</li>`;
  });
  html += "</ul>";
  detalle.innerHTML = html;

  // Muestra el modal de revisi√≥n de pedido
  document.getElementById("modal-revision-pedido").classList.add("show");
};

document.getElementById("confirmar-pedido").onclick = function() {
  let carrito = [];
  try { carrito = JSON.parse(localStorage.getItem('carrito') || '[]'); } catch(e){ carrito = []; }
  if (!carrito.length) return;

  // Obt√©n tipo, mesa, delivery
  let tipo = window.pedidoTipo;
  let mesa = tipo === "mesa" ? window.mesaSeleccionada : "";
  let delivery = tipo === "delivery" ? (document.getElementById("delivery-select").value || "") : "";

  // Calcula el total
  let total = carrito.reduce((acc, prod) => acc + prod.precio * prod.cantidad, 0);

  // Crea el pedido
  let pedidos = JSON.parse(localStorage.getItem("pedidos") || "[]");
  let numeroPedido = pedidos.length ? pedidos[pedidos.length - 1].numeroPedido + 1 : 1;
  let fecha = new Date();
  let pedido = {
    numeroPedido: numeroPedido,
    fecha: fecha.getDate().toString().padStart(2, "0") + "/" + (fecha.getMonth() + 1).toString().padStart(2, "0") + "/" + fecha.getFullYear(),
    hora: fecha.getHours().toString().padStart(2, "0") + ":" + fecha.getMinutes().toString().padStart(2, "0"),
    tipo: tipo,
    mesa: mesa,
    delivery: delivery,
    productos: carrito,
    total: total
  };

  // Guarda el pedido
  pedidos.push(pedido);
  localStorage.setItem("pedidos", JSON.stringify(pedidos));

  // Limpia el carrito
  localStorage.removeItem('carrito');
  document.getElementById("modal-revision-pedido").classList.remove("show");
  document.getElementById("modal-confirmacion-pedido").classList.add("show");
  document.getElementById("total").textContent = "0.00";
};

document.getElementById("cerrar-confirmacion-pedido").onclick = function() {
  document.getElementById("modal-confirmacion-pedido").classList.remove("show");
};
</script>



<script src="/model.js"></script>
<script src="/view.js"></script>
<script src="/controller.js"></script>
</body>
</html>

